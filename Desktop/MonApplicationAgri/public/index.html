<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgriConnect | Le March√© Direct</title>
    <div style="margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="filtrerParCategorie('Tous')" class="btn-filter">Tous</button>
        <button onclick="filtrerParCategorie('L√©gumes')" class="btn-filter">L√©gumes</button>
        <button onclick="filtrerParCategorie('Fruits')" class="btn-filter">Fruits</button>
        <button onclick="filtrerParCategorie('Tubercules')" class="btn-filter">Tubercules</button>
    </div>

    <style>
    .btn-filter {
        padding: 8px 20px;
        border: 2px solid #27ae60;
        background: white;
        color: #27ae60;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
    }
    .btn-filter:hover {
        background: #27ae60;
        color: white;
    }
    </style>
    <style>
        :root { --primary: #27ae60; --dark: #2c3e50; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--light); color: var(--dark); }
        
        /* Barre de Navigation */
        nav { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 24px; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-links a { text-decoration: none; color: var(--dark); margin-left: 20px; font-weight: 500; transition: 0.3s; }
        .btn-green { background: var(--primary); color: white !important; padding: 10px 20px; border-radius: 5px; }

        /* Section Hero (L'accueil) */
        .hero { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1464226184884-fa280b87c399?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'); 
                height: 450px; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 0 20px; }
        .hero h1 { font-size: 3rem; margin-bottom: 10px; }
        .search-bar { background: white; padding: 10px; border-radius: 50px; display: flex; width: 100%; max-width: 600px; margin-top: 30px; }
        .search-bar input { border: none; padding: 10px 20px; flex: 1; border-radius: 50px; outline: none; font-size: 16px; }
        .search-bar button { background: var(--primary); border: none; color: white; padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: bold; }

        

        /* Grille de Produits */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #eee; }
        .card:hover { transform: translateY(-10px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-body { padding: 20px; }
        .price { font-size: 1.4rem; color: var(--primary); font-weight: bold; }
        .status { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
    </style>
    
</head>
<body>
<audio id="audio-ding" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <nav>
        <div class="logo"><span>üöú</span> AgriConnect</div>
        <div class="nav-links" id="nav-links">
            <a href="index.html">Accueil</a>
            <a href="a-propos.html">√Ä Propos</a>
            </div>
    </nav>

    <section class="hero">
        <h1>Le champ s'invite chez vous</h1>
        <p>Achetez frais, achetez local, soutenez nos agriculteurs.</p>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Que recherchez-vous ? (Tomates, Manioc...)" onkeyup="filtrerProduits()">
            <button onclick="filtrerProduits()">Rechercher</button>
        </div>
    </section>

    <div style="margin-bottom: 30px; display: flex; align-items: center; gap: 15px;">
        <label for="triPrix" style="font-weight: bold;">Trier par :</label>
        <select id="triPrix" onchange="trierLesProduits()" style="padding: 8px; border-radius: 5px; border: 1px solid #27ae60;">
             <option value="default">Nouveaut√©s (Par d√©faut)</option>
             <option value="croissant">Prix : Moins cher au plus cher</option>
             <option value="decroissant">Prix : Plus cher au moins cher</option>
        </select>
    </div>

    <div class="container">
        <h2 id="titre-marche">ü•¨ Produits Frais Disponibles</h2>
        <div id="market-grid" class="grid">
            </div>
    </div>

    <script>
        let panier = [];
        // Gestion de la Navbar Dynamique
        const userNom = localStorage.getItem('userName');
        const navLinks = document.getElementById('nav-links');
        if (userNom) {
            navLinks.innerHTML += `
                <a href="dashboard.html">Mon Espace</a>
                <a href="#" onclick="deconnexion()" class="btn-green">D√©connexion (${userNom})</a>
            `;
        } else {
            navLinks.innerHTML += `
                <a href="login.html">Connexion</a>
                <a href="register.html" class="btn-green">Cr√©er un compte</a>
            `;
        }

    function gererMenu() {
         const userName = localStorage.getItem('userName');
         const navLogin = document.getElementById('nav-login');
         const userNameDisplay = document.getElementById('user-name');

      if (userName) {
        // L'utilisateur est connect√©
         navLogin.innerHTML = '<a href="#" onclick="deconnexion()" style="color: #e74c3c; text-decoration: none; margin-left: 15px;">D√©connexion</a>';
        userNameDisplay.innerText = "üëã " + userName;
        }
    }

    function deconnexion() {
         localStorage.clear(); // On vide les badges
         window.location.href = "login.html"; // Retour au login
    }

    // On lance la v√©rification au chargement de la page
     gererMenu();

        function deconnexion() {
            localStorage.clear();
            window.location.reload();
        }

        // Chargement des produits
        let tousLesProduits = [];

        async function chargerMarche() {
            const response = await fetch('/api/products');
            tousLesProduits = await response.json();
            afficherProduits(tousLesProduits);
        }

    function filtrerParCategorie(cat) {
        if (cat === 'Tous') {
             afficherProduits(tousLesProduits);
        } else {
             const filtres = tousLesProduits.filter(p => p.categorie === cat);
             afficherProduits(filtres);
        }
    }

        function afficherProduits(liste) {
            const grid = document.getElementById('market-grid');
            grid.innerHTML = '';
            liste.forEach(p => {
                grid.innerHTML += `
                    <div class="card">
                        <img src="${p.image || 'https://via.placeholder.com/300'}" alt="${p.nom}">
                        <div class="card-body">
                            <span class="status" style="background: ${p.statut === 'disponible' ? '#e8f5e9' : '#ffebee'}; color: ${p.statut === 'disponible' ? '#27ae60' : '#e74c3c'};">
                                ‚óè ${p.statut.toUpperCase()}
                            </span>
                            <h3>${p.nom}</h3>
                            <div class="price">${p.prix} FCFA / ${p.unite}</div>
                            <p>üìç ${p.agriculteur?.adresse || 'C√¥te d\'Ivoire'}</p>
                    
                            <button onclick="ajouterAuPanier('${p._id}', '${p.nom}', ${p.prix}, '${p.agriculteur?.telephone}')" 
                                style="width: 100%; background: #2c3e50; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold;">
                                üõí Ajouter au panier
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function trierLesProduits() {
            const choix = document.getElementById('triPrix').value;
            let produitsTries = [...tousLesProduits]; // On fait une copie de la liste pour ne pas ab√Æmer l'originale

            if (choix === "croissant") {
                 produitsTries.sort((a, b) => a.prix - b.prix);
            } else if (choix === "decroissant") {
                 produitsTries.sort((a, b) => b.prix - a.prix);
            } else {
        // Si "default", on recharge la liste originale (souvent par date)
        return chargerMarche();
    }

    afficherProduits(produitsTries);
}

        // Syst√®me de recherche instantan√©e
        function filtrerProduits() {
            const texte = document.getElementById('searchInput').value.toLowerCase();
            const produitsFiltr√©s = tousLesProduits.filter(p => 
                p.nom.toLowerCase().includes(texte) || 
                p.description.toLowerCase().includes(texte)
            );
            afficherProduits(produitsFiltr√©s);
        }

       function ajouterAuPanier(id, nom, prix, tel) {
            // 1. Jouer le son "Ding"
            const son = document.getElementById('audio-ding');
            son.currentTime = 0; // Remet le son au d√©but si on clique vite
            son.play();

            // 2. La logique que tu as d√©j√†
            const produitExiste = panier.find(item => item.id === id);
            if (produitExiste) {
                produitExiste.quantite += 1;
            } else {
                panier.push({ id, nom, prix, tel, quantite: 1 });
            }
    
            // 3. Petite animation visuelle (optionnel mais sympa)
             majAffichagePanier();
       }

        function majAffichagePanier() {
             const divPanier = document.getElementById('panier-flottant');
             const listeDiv = document.getElementById('liste-panier');
             const totalDiv = document.getElementById('total-prix');
    
            if (panier.length === 0) {
                divPanier.style.display = 'none';
                return;
            }

            divPanier.style.display = 'block';
            listeDiv.innerHTML = panier.map(item => `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px;">
                     <span>${item.nom} (x${item.quantite})</span>
                     <span>${item.prix * item.quantite} FCFA</span>
                </div>
            `).join('');

            const total = panier.reduce((sum, item) => sum + (item.prix * item.quantite), 0);
            totalDiv.innerText = `${total} FCFA`;
        }

        function viderPanier() {
            panier = [];
            majAffichagePanier();
        }

        async function finaliserLaCommande() {
            if (panier.length === 0) return;

            const token = localStorage.getItem('userToken'); // On r√©cup√®re le badge de connexion
            if (!token) {
                alert("Vous devez √™tre connect√© pour commander !");
                window.location.href = "login.html";
                return;
            }

            // Pr√©paration des donn√©es pour ton serveur
             const commandeData = {
                 acheteurId: localStorage.getItem('userId'),
                 items: panier.map(item => ({
                     produitId: item.id,
                     quantite: item.quantite
                 }))
             };

             try {
                 const response = await fetch('/api/orders', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'Authorization': `Bearer ${token}`
                     },
                     body: JSON.stringify(commandeData)
                 });

                 const resultat = await response.json();

                if (response.ok) {
                     alert("Commande enregistr√©e ! Redirection vers le paiement...");
                     // C'est ici qu'on redirigera vers FedaPay ou CinetPay plus tard
                     console.log("ID de commande :", resultat.commandeId);
            
                     // Pour l'instant, on finit quand m√™me sur WhatsApp pour ne pas bloquer le client
                     envoyerCommandeWhatsApp(); 
                } else {
                     alert("Erreur : " + resultat.message);
                 }
            } catch (error) {
                 console.error("Erreur lors de la commande:", error);
            }
         }

        chargerMarche();
    </script>

<div id="panier-flottant" style="position: fixed; right: 20px; bottom: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 320px; display: none; z-index: 2000; border: 2px solid #27ae60;">
    <h3 style="margin-top: 0; color: #27ae60;">üõí Votre Panier</h3>
    <div id="liste-panier" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;"></div>
    <div style="border-top: 2px solid #eee; padding-top: 10px; font-weight: bold; font-size: 1.2rem; display: flex; justify-content: space-between;">
        <span>Total :</span>
        <span id="total-prix">0 FCFA</span>
    </div>
    <button onclick="envoyerCommandeWhatsApp()" class="btn-green" style="width: 100%; margin-top: 15px; border: none; cursor: pointer; font-size: 16px;">Finaliser la commande</button>
    <button onclick="viderPanier()" style="background: none; border: none; color: #e74c3c; cursor: pointer; width: 100%; margin-top: 10px; font-size: 13px;">Vider le panier</button>
</div>
<footer style="background: #2c3e50; color: white; padding: 40px 5% 20px 5%; margin-top: 50px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto;">
        
        <div>
            <h3 style="color: #27ae60; margin-bottom: 15px;">üöú AgriConnect</h3>
            <p style="font-size: 14px; opacity: 0.8;">La technologie au service de la terre. Nous connectons le savoir-faire local aux tables des familles.</p>
        </div>

        <div>
            <h4 style="margin-bottom: 15px;">Navigation</h4>
            <ul style="list-style: none; padding: 0; font-size: 14px; line-height: 2;">
                <li><a href="index.html" style="color: white; text-decoration: none; opacity: 0.8;">Le March√©</a></li>
                <li><a href="a-propos.html" style="color: white; text-decoration: none; opacity: 0.8;">√Ä Propos</a></li>
                <li><a href="register.html" style="color: white; text-decoration: none; opacity: 0.8;">Devenir Vendeur</a></li>
            </ul>
        </div>

        <div>
            <h4 style="margin-bottom: 15px;">Contact</h4>
            <p style="font-size: 14px; opacity: 0.8;">üìç Abidjan, C√¥te d'Ivoire</p>
            <p style="font-size: 14px; opacity: 0.8;">üìß contact@agriconnect.ci</p>
            <p style="font-size: 14px; opacity: 0.8;">üìû +225 07 00 00 00 00</p>
        </div>

    </div>

    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; opacity: 0.6;">
        <p>&copy; 2025 AgriConnect - Tous droits r√©serv√©s.</p>
    </div>
</footer>
</body>
</html>