<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriConnect | Le March√© Direct</title>
    <style>
        :root { --primary: #27ae60; --dark: #2c3e50; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: var(--dark); }
        nav { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 24px; font-weight: bold; color: var(--primary); }
        .btn-green { background: var(--primary); color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        
        /* Filtres cat√©gories */
        .categories-chips { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .chip { background: white; border: 1px solid var(--primary); color: var(--primary); padding: 8px 18px; border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 500; }
        .chip.active { background: var(--primary); color: white; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; transition: 0.3s; }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .badge-price { position: absolute; top: 15px; left: 15px; background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        
        #panier-flottant { position: fixed; right: 20px; bottom: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 320px; display: none; z-index: 2000; border: 2px solid var(--primary); }
        .search-container { margin: 20px 0; }
        #search-bar { width: 100%; padding: 15px; border-radius: 30px; border: 1px solid #ddd; font-size: 16px; outline: none; box-sizing: border-box; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">üöú AgriConnect</div>
        <div id="auth-zone"></div>
    </nav>

    <div class="container">
        <div class="search-container">
            <input type="text" id="search-bar" placeholder="üîç Rechercher un produit (tomate, igname...)...">
        </div>

        <div class="categories-chips" id="cat-chips">
            <div class="chip active" onclick="filtrerParCategorie('tous', this)">Tous</div>
            <div class="chip" onclick="filtrerParCategorie('L√©gumes', this)">L√©gumes</div>
            <div class="chip" onclick="filtrerParCategorie('Fruits', this)">Fruits</div>
            <div class="chip" onclick="filtrerParCategorie('C√©r√©ales', this)">C√©r√©ales</div>
            <div class="chip" onclick="filtrerParCategorie('Tubercules', this)">Tubercules</div>
        </div>

        <h3>ü•¨ Produits Frais</h3>
        <div id="market-grid" class="grid"></div>
    </div>

    <div id="panier-flottant">
        <h3 style="color: var(--primary); margin-top:0;">üõí Votre Panier</h3>
        <div id="liste-panier" style="max-height: 200px; overflow-y: auto;"></div>
        <hr>
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span>Total :</span><span id="total-prix">0 FCFA</span>
        </div>
        <button onclick="envoyerCommandeWhatsApp()" class="btn-green" style="width:100%; margin-top:10px;">Commander via WhatsApp</button>
    </div>

    <script>
        let tousLesProduits = [];
        let panier = JSON.parse(localStorage.getItem('monPanier')) || [];

        async function chargerDonnees() {
            try {
                const res = await fetch('/api/products');
                tousLesProduits = await res.json();
                afficherProduits(tousLesProduits);
                mettreAJourAffichagePanier();
                gererZoneAuth();
            } catch (err) { console.error("Erreur chargement:", err); }
        }

        function gererZoneAuth() {
            const authZone = document.getElementById('auth-zone');
            const token = localStorage.getItem('token');
            authZone.innerHTML = token 
                ? `<a href="dashboard.html" class="btn-green" style="text-decoration:none;">üë®‚Äçüåæ Mon Espace Business</a>`
                : `<a href="login.html" style="color:var(--primary); text-decoration:none; font-weight:bold;">Connexion Agriculteur</a>`;
        }

        function afficherProduits(liste) {
            const grid = document.getElementById('market-grid');
            if (liste.length === 0) {
                grid.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>Aucun produit trouv√©.</p>";
                return;
            }
            grid.innerHTML = liste.map(p => `
                <div class="card">
                    <div class="badge-price">${p.prix} F</div>
                    <img src="${p.image || 'https://via.placeholder.com/300'}" alt="${p.nom}">
                    <div style="padding:15px;">
                        <h4 style="margin:0;">${p.nom}</h4>
                        <small style="color:#666;">
                            ${p.categorie} | Stock: ${p.quantite} ${p.unite || 'u'} <br>
                            üë®‚Äçüåæ ${p.agriculteur?.nom || 'Producteur'}
                        </small>
                        <button onclick="ajouterAuPanier('${p._id}', '${p.nom}', ${p.prix}, '${p.agriculteur?.telephone || ''}')" 
                                class="btn-green" style="width:100%; margin-top:10px;" 
                                ${p.statut === '√©puis√©' ? 'disabled style="background:#ccc"' : ''}>
                            ${p.statut === '√©puis√©' ? '√âpuis√©' : 'Ajouter au panier'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filtrerParCategorie(cat, el) {
            // UI : changer la puce active
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');

            // Logique de filtre
            const filtre = cat === 'tous' 
                ? tousLesProduits 
                : tousLesProduits.filter(p => p.categorie === cat);
            afficherProduits(filtre);
        }

        function ajouterAuPanier(id, nom, prix, telVendeur) {
            const item = panier.find(i => i.id === id);
            if (item) { item.quantite++; } 
            else { panier.push({id, nom, prix, quantite: 1, telVendeur}); }
            sauvegarderEtAfficher();
        }

        function retirerDuPanier(id) {
            panier = panier.filter(i => i.id !== id);
            sauvegarderEtAfficher();
        }

        function envoyerCommandeWhatsApp() {
            if (panier.length === 0) return;

            const commandesParVendeur = panier.reduce((acc, item) => {
                const tel = item.telVendeur || "22500000000"; 
                if (!acc[tel]) acc[tel] = [];
                acc[tel].push(item);
                return acc;
            }, {});

            for (const tel in commandesParVendeur) {
                const items = commandesParVendeur[tel];
                let msg = `Bonjour ! Commande AgriConnect :\n\n`;
                items.forEach(i => msg += `‚Ä¢ ${i.nom} (x${i.quantite}) : ${i.prix * i.quantite} F\n`);
                const total = items.reduce((sum, i) => sum + (i.prix * i.quantite), 0);
                msg += `\nüí∞ Total : ${total} FCFA`;
                window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
            }

            panier = [];
            sauvegarderEtAfficher();
        }

        function sauvegarderEtAfficher() {
            localStorage.setItem('monPanier', JSON.stringify(panier));
            mettreAJourAffichagePanier();
        }

        function mettreAJourAffichagePanier() {
            const display = document.getElementById('panier-flottant');
            const liste = document.getElementById('liste-panier');
            if (panier.length > 0) {
                display.style.display = 'block';
                liste.innerHTML = panier.map(i => `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px;">
                        <span>${i.nom} (x${i.quantite})</span>
                        <span>${i.prix * i.quantite} F <button onclick="retirerDuPanier('${i.id}')" style="background:none; border:none; color:red; cursor:pointer;">‚úï</button></span>
                    </div>
                `).join('');
                document.getElementById('total-prix').innerText = panier.reduce((acc, i) => acc + (i.prix * i.quantite), 0) + " FCFA";
            } else { display.style.display = 'none'; }
        }

        document.getElementById('search-bar').addEventListener('input', (e) => {
            const terme = e.target.value.toLowerCase();
            const filtres = tousLesProduits.filter(p => p.nom.toLowerCase().includes(terme));
            afficherProduits(filtres);
        });

        window.onload = chargerDonnees;
    </script>
</body>
</html>