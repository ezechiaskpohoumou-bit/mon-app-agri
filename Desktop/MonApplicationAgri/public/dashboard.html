<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Espace - AgriConnect</title>
    <style>
        :root { --primary: #27ae60; --danger: #e74c3c; --warning: #f1c40f; --info: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        
        /* Navbar */
        .navbar { background: var(--primary); color: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Profil Section */
        #user-profile { background: white; padding: 20px; border-bottom: 1px solid #ddd; text-align: center; }
        #user-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        
        /* Contenu */
        .container { max-width: 1000px; margin: 30px auto; padding: 20px; }
        .header-box { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Cartes Produits */
        .product-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .product-info h3 { margin: 0; color: #2c3e50; font-size: 1.2rem; }
        .badge-price { background: #e8f5e9; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: bold; display: inline-block; margin: 10px 0; }
        .status-tag { font-size: 0.85rem; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        .status-disponible { background: #d4edda; color: #155724; }
        .status-epuise { background: #f8d7da; color: #721c24; }
        
        /* Boutons */
        .btn-action { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 5px; transition: 0.2s; color: white; }
        .btn-add { background: var(--primary); color: white; text-decoration: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; display: inline-block; }
        .logout-btn { background: transparent; border: 1px solid white; color: white; padding: 5px 10px; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <h2>üöú AgriConnect Business</h2>
        <div>
            <a href="index.html" style="color: white; text-decoration: none; margin-right: 15px;">Voir le March√©</a>
            <button onclick="deconnexion()" class="logout-btn">D√©connexion</button>
        </div>
    </nav>

    <div id="user-profile" style="display: none;">
        <img id="user-photo" src="" alt="Profil">
        <h3 id="user-name">Chargement...</h3>
        <p id="user-email" style="color: #666; font-size: 0.9rem;"></p>
    </div>

    <div class="container">
        <div class="header-box">
            <h1 id="welcome-msg">Bienvenue</h1>
            <p>G√©rez vos stocks et vos prix en temps r√©el.</p>
            <br>
            <a href="ajouter-produit.html" class="btn-add">+ Ajouter un nouveau produit</a>
        </div>

        <div id="my-products-list">
            </div>
    </div>

    <script>
        // --- GESTION DU PROFIL ---
        async function chargerProfil() {
            const token = localStorage.getItem('token');
            if (!token) { window.location.href = "login.html"; return; }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('user-profile').style.display = 'block';
                    document.getElementById('user-name').innerText = user.nom;
                    document.getElementById('user-email').innerText = user.email;
                    document.getElementById('user-photo').src = user.photo || 'https://via.placeholder.com/80';
                    document.getElementById('welcome-msg').innerText = `Espace de ${user.nom}`;
                } else {
                    deconnexion();
                }
            } catch (error) {
                console.error("Erreur profil:", error);
            }
        }

        // --- GESTION DES PRODUITS ---
        async function chargerMesProduits() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/products/my-products', {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            const produits = await response.json();
            const listeDiv = document.getElementById('my-products-list');
            listeDiv.innerHTML = '';

            if (!produits || produits.length === 0) {
                listeDiv.innerHTML = `<p style="text-align:center; color:#999;">Aucun produit en vente.</p>`;
                return;
            }

            produits.forEach(p => {
                const isDispo = p.statut === 'disponible';
                listeDiv.innerHTML += `
                    <div class="product-card">
                        <div class="product-info">
                            <h3>${p.nom}</h3>
                            <div class="badge-price">${p.prix} FCFA</div><br>
                            <span class="status-tag ${isDispo ? 'status-disponible' : 'status-epuise'}">${p.statut}</span>
                        </div>
                        <div class="actions">
                            <button onclick="changerPrix('${p._id}')" class="btn-action" style="background:var(--warning); color:black;">üí∞ Prix</button>
                            <button onclick="changerStatut('${p._id}', '${p.statut}')" class="btn-action" style="background:var(--info)">üì¶ Stock</button>
                            <button onclick="supprimerProduit('${p._id}')" class="btn-action" style="background:var(--danger)">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }

        async function appelerAPI(id, donnees) {
            await fetch(`/api/products/${id}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token') 
                },
                body: JSON.stringify(donnees)
            });
            chargerMesProduits();
        }

        async function changerPrix(id) {
            const prix = prompt("Nouveau prix (FCFA) :");
            if (prix) await appelerAPI(id, { prix: parseInt(prix) });
        }

        async function changerStatut(id, actuel) {
            const nouveau = actuel === 'disponible' ? '√©puis√©' : 'disponible';
            await appelerAPI(id, { statut: nouveau });
        }

        async function supprimerProduit(id) {
            if(confirm("Supprimer ce produit ?")) {
                await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                chargerMesProduits();
            }
        }

        function deconnexion() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        // Initialisation
        window.onload = () => {
            chargerProfil();
            chargerMesProduits();
        };
    </script>
</body>
</html>